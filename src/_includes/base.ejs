<!doctype html>
<html class="no-js" lang="" class="no-dark-theme">
    <head>
        <meta charset="utf-8">
        <title><%= title %></title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link rel="shortcut icon" type="image/png" href="/asset/img/favicon.png">
        <link rel="stylesheet" href="https://the.missing.style/v0.1.0/missing.min.css">

        <script src="https://unpkg.com/htmx.org@1.8.0"></script>
        <script src="https://unpkg.com/hyperscript.org@0.9.7"></script>
        <style type="text/css" media="screen">
         /* Begin modifications to missing.style */

         :root {
             --accent: #1a6c28;
             --box-bg: #e9ffef;
         }

         html, body {
             height: 100%;
         }

         body {
             display: flex;
             flex-direction: column;
         }

         header {
             flex-shrink: 0;
         }

         footer {
             flex-shrink: 0;
         }

         main {
             inline-size: var(--eff-line-length);
             flex-grow: 1;
         }

         footer.navbar {
             position: static;
             bottom: 0;
             left: 0;
             right: 0;
             border-block-end: none;

             margin-block-start: calc(var(--gap));
             margin-block-end: 0;
         }

         hr {
             margin-block-end: 0.25rem !important;
         }

         header.navbar{
             justify-content: flex-start;
         }

         .navbar {
             /* The translate on the box titlebar covers the navbar unless this */
             z-index: 1;
         }

         header.navbar > nav,
         footer.navbar > nav
         {
             margin: var(--gap);
             margin-block-end: calc(var(--gap) / 2)
         }

         header.sticky {
             top: 0px;
             filter: drop-shadow(0.00rem -1.8rem 2.0rem var(--box-bg));
         }

         :is(.navbar,header[is="nav-bar"]) a {
             font-weight: 500;
         }

         .titlebar {
             font-weight: 400;
             font-size: 1.1em;
             padding-block-start: calc(var(--gap) / 3);
             padding-block-end: calc(var(--gap) / 4);
         }

         nav ul, nav ol {
             list-style: none;
         }

         ol, ol[role=list], ul, ul[role=list] {
             padding-left: 0.2rem;
         }

         ol {
             list-style: none;
             counter-reset: counter-function;
         }

         ol li {
             counter-increment: counter-function;
             margin: 0.1rem;
             display: flex;
             align-items: center; /* adjust as needed */
         }

         ol li::before {
             content: counter(counter-function) ".";
             flex: 0 0 1.8rem;
             text-align: left;
             margin-right: 0rem; /* adjust as needed */
         }

         h1, h2 {
             font-weight: normal;
         }

         button, input[type="submit"] {
             cursor: pointer;
         }

         /* End modifications to missing.style */

         body > svg { display: none; }

         header.navbar {
             background: linear-gradient(to right, #3b9b80, var(--box-bg) 100px);
         }

         footer.navbar {
             background: linear-gradient(to left, #3b9b80, var(--box-bg) 100px);
         }


         .logo {
             --logo-size: 1.4rem;
             display: inline-block;

             height: var(--logo-size);
             width: var(--logo-size);
             margin-block-start: calc(var(--logo-size) - 1.7rem);
             margin-inline-end: calc(var(--gap) / 2) !important;
         }

         a:hover .logo {
             text-decoration: underline;
         }

         .comment-start {
             position: fixed;
             top: 0;
             left: 0;
         }
        </style>

    </head>
    <body>
        <svg
            xmlns:svg="http://www.w3.org/2000/svg"
            xmlns="http://www.w3.org/2000/svg"
            version="1.1"
            width="32"
            height="32">
            <symbol id="symLogo" viewBox="0 0 32 32">
                <g>
                    <g transform="translate(-0.06806793,-0.06858534)">
                        <g transform="translate(-1.0833332,0.64874049)">
                            <path
                                d="m 17.151401,1.2352327 c -7.8313964,0 -14.1983698,6.339457 -14.1983698,14.1708533 0,7.831397 6.3669734,14.198371 14.1983698,14.198371 7.831397,0 14.19837,-6.366974 14.19837,-14.198371 0,-7.8313963 -6.366973,-14.1708533 -14.19837,-14.1708533 z m 0,0.9080353 c 7.334485,0 13.262819,5.9283344 13.262819,13.262818 0,7.334484 -5.928334,13.290336 -13.262819,13.290336 -7.3344838,0 -13.2628183,-5.955852 -13.2628183,-13.290336 0,-7.3344836 5.9283345,-13.262818 13.2628183,-13.262818 z"/>
                            <path
                                d="m 13.334885,28.322261 c 1.049976,0.635512 0.813218,0.640253 2.084242,0.502099 0,0 7e-6,-6.11225 0.05526,-10.042771 0.05525,-3.93052 2.413483,-6.274778 6.948442,-7.694814 3.055071,-0.956636 3.267743,-1.9168298 1.598667,-1.9168298 -5.408328,0 -8.566885,3.6979468 -8.566885,3.6979468 0,0 0.552801,-1.608397 -0.12393,-2.583228 C 13.31872,7.3864336 13.50293,11.20716 13.47304,12.836193 l -0.110524,6.023548 c -0.0703,3.83139 -0.02763,9.46252 -0.02763,9.46252 z"
                            />
                        </g>
                    </g>
                </g>
            </symbol>
        </svg>
        <header class="navbar sticky">
            <nav class="f-row">
                <ul role="list">
                    <li><a href="/">

                                <svg class="logo margin-inline">
                                    <use xlink:href="#symLogo" x="0" y="0" />
                                </svg>&nbsp;reed's website</a></li>
                </ul>
                <hr />
                <ul role="list">
                    <li><a href="/blog">blog</a></li>
                    <li><a href="/work.html">work</a></li>
                </ul>
            </nav>
        </header>
        <main hx-boost="true">
            <article
                _="
                   init
                     set $commentStart to <.comment-start />
                     set $comment to <.comment />
                     set $commentQuote to first <blockquote /> in $comment
                     set $commentSelectionInput to #comment-selection in $comment
                     set $commentContext to #comment-context in $comment
                     set $commentTargetContainer to null
                   end

           on selectionchange from document
             set selection to document.getSelection()

             -- First, if the selection is changing to within the comment
             -- then cancel the event entirely
             set anchorElement to selection.anchorNode
             if anchorElement.nodeType is Node.TEXT_NODE then
               set anchorElement to anchorElement.parentElement
             end
             get the closest <.comment /> to the anchorElement
             if the result is not null then
                   halt the event
                   exit
             end

             -- Don't do anything if the selection is empty
             if selection.isCollapsed then exit end

             -- Determine which comes later, the anchor or the focus
             -- https://stackoverflow.com/a/23512678
             set position to selection.anchorNode.compareDocumentPosition(selection.focusNode)
             set $commentTargetContainer to selection.focusNode
             set isSameNodeAndBackwards to ((position is 0) and (selection.anchorOffset > selection.focusOffset))
             if isSameNodeAndBackwards or (position is Node.DOCUMENT_POSITION_PRECEDING) then
               set $commentTargetContainer to selection.anchorNode
             end

             -- Find the container paragraph or other element (not text node)
             if $commentTargetContainer.nodeType is Node.TEXT_NODE then
               set $commentTargetContainer to $commentTargetContainer.parentElement
             end
             get the closest <p /> to $commentTargetContainer
             if the result is not null then
               set conatiner to the result
             end


             -- Don't show the comment widget if the selection expands outside of the article
             get the closest <article /> to $commentTargetContainer
             if the result is null then exit end

             -- Align widget with the container
             measure element $commentTargetContainer's left, bottom
             set $commentStart's *left to left px
             set $commentStart's *top to (bottom + 10) px

             show $commentStart

             -- put the text into the comment's quote area AND a hidden input
             put selection.toString() into $commentQuote
             put selection.toString() into $commentSelectionInput's value
             -- add the greater context of the entire $commentTargetContainer's text
             put innerText of $commentTargetContainer into $commentContext's value
           "
            >
                <%- content %>
            </article>

            <% if (typeof discussionUrl !== "undefined") { %>
                <div class="box">
                    <strong class="block titlebar">Discuss</strong>
                    <p>
                        To give me feedback on this post, select some text.
                        A "Comment" button will appear. Click that and fill
                        out the form which appears. I really appreciate your
                        feedback!
                    </p>
                    <p>
                        Discuss this post in
                        <a href="<%- discussionUrl %>" target="_blank">
                            the official thread
                        </a>
                        in the subreddit.
                    </p>
                </div>
            <% } %>
        </main>
        <footer class="navbar">
            <nav class="f-row margin-inline">
                <ul role="list">
                    <li>
                        <a href="#">back to top ↑</a>
                    </li>
                </ul>
                <hr />
                <ul role="list">
                    <li>
                        <a href="/">
                            <svg class="logo margin-inline">
                                <use xlink:href="#symLogo" x="0" y="0" />
                            </svg>
                        </a>
                    </li>
                </ul>
            </nav>
        </footer>
        <button
            class="comment-start"
            style="display: none; padding-inline: var(--gap); padding-block: calc(var(--gap) / 4); border-radius: var(--gap);"
            _="
                   on click
                     put $comment after $commentTargetContainer
                     show $comment
                     hide me
                   "
        >Comment</button>
        <div class="comment box" style="display: none;">
            <strong
                class="block titlebar"
                style="display: flex; justify-content: space-between;"
            >
                Comment
                <button class="close-button"
                        _="on click hide closest <.comment />"
                >X</button>
            </strong>
            <form method="POST" name="article-comment" hx-post="/" data-netlify="true" class="table" netlify-honeypot="bot-field">
                <p>Send a comment to me. Your selection will be included.</p>

                <p>
                    <blockquote style="white-space: pre-wrap;">Your selection</blockquote>
                </p>
                <p style="display: none;">
                    <label for="comment-selection">Your selection:</label>
                    <textarea
                        name="selection"
                        id="comment-selection"
                        style="width: 100%;"
                    ></textarea>
                </p>
                <p>
                    <label for="comment-content">Your comment:</label>
                    <textarea
                        name="content"
                        id="comment-content"
                        style="width: 100%;"
                    ></textarea>
                </p>
                <p style="display: none;">
                    <label for="comment-context">The context:</label>
                    <textarea
                        name="context"
                        id="comment-context"
                    ></textarea>
                </p>
                <p style="display: none;">
                    <label>
                        Don’t fill this out if you’re human: <input name="bot-field" />
                    </label>
                </p>
                <p>
                    <input type="submit" name="submit" value="Submit" id="comment-submit" />
                    <button class="close-button"
                            _="on click hide closest <.comment /> then halt"
                    >Cancel</button>
                </p>
                <p><em>P.S. Don't worry about an imperfect selection. I'll also get the context.</em></p>


            </form>
        </div>
    </body>
</html>
