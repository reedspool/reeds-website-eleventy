<!doctype html>
<html class="no-js" lang="" class="no-dark-theme">
    <head>
        <meta charset="utf-8">
        <title><%= title %></title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link rel="shortcut icon" type="image/png" href="/asset/img/favicon.png">
        <link rel="stylesheet" href="https://the.missing.style/v0.1.0/missing.min.css">

        <script src="https://unpkg.com/htmx.org@1.8.0"></script>
        <script src="https://unpkg.com/hyperscript.org@0.9.7"></script>
        <style type="text/css" media="screen">
         /* Begin modifications to missing.style */

         :root {
             --accent: #1a6c28;
             --box-bg: #e9ffef;
         }

         html, body {
             height: 100%;
         }

         body {
             display: flex;
             flex-direction: column;
         }

         header {
             flex-shrink: 0;
         }

         footer {
             flex-shrink: 0;
         }

         main {
             inline-size: var(--eff-line-length);
             flex-grow: 1;
         }

         footer.navbar {
             position: static;
             bottom: 0;
             left: 0;
             right: 0;
             border-block-end: none;

             margin-block-start: calc(var(--gap));
             margin-block-end: 0;
         }

         hr {
             margin-block-end: 0.25rem !important;
         }

         header.navbar{
             justify-content: flex-start;
         }

         .navbar {
             /* The translate on the box titlebar covers the navbar unless this */
             z-index: 1;
         }

         header.navbar > nav,
         footer.navbar > nav
         {
             margin: var(--gap);
             margin-block-end: calc(var(--gap) / 2)
         }

         header.sticky {
             top: 0px;
             filter: drop-shadow(0.00rem -1.8rem 2.0rem var(--box-bg));
         }

         :is(.navbar,header[is="nav-bar"]) a {
             font-weight: 500;
         }

         .titlebar {
             font-weight: 400;
             font-size: 1.1em;
             padding-block-start: calc(var(--gap) / 3);
             padding-block-end: calc(var(--gap) / 4);
         }

         nav ul, nav ol {
             list-style: none;
         }

         ol, ol[role=list], ul, ul[role=list] {
             padding-left: 0.2rem;
         }

         ol {
             list-style: none;
             counter-reset: counter-function;
         }

         ol li {
             counter-increment: counter-function;
             margin: 0.1rem;
             display: flex;
             align-items: center; /* adjust as needed */
         }

         ol li::before {
             content: counter(counter-function) ".";
             flex: 0 0 1.8rem;
             text-align: left;
             margin-right: 0rem; /* adjust as needed */
         }

         h1, h2 {
             font-weight: normal;
         }

         button, input[type="submit"] {
             cursor: pointer;
         }

         /* End modifications to missing.style */

         body > svg { display: none; }

         header.navbar {
             background: linear-gradient(to right, #3b9b80, var(--box-bg) 100px);
         }

         footer.navbar {
             background: linear-gradient(to left, #3b9b80, var(--box-bg) 100px);
         }


         .logo {
             --logo-size: 1.4rem;
             display: inline-block;

             height: var(--logo-size);
             width: var(--logo-size);
             margin-block-start: calc(var(--logo-size) - 1.7rem);
             margin-inline-end: calc(var(--gap) / 2) !important;
         }

         a:hover .logo {
             text-decoration: underline;
         }

         .comment-start {
             position: fixed;
             top: 0;
             left: 0;
         }
        </style>

    </head>
    <body>
        <svg
            xmlns:svg="http://www.w3.org/2000/svg"
            xmlns="http://www.w3.org/2000/svg"
            version="1.1"
            width="32"
            height="32">
            <symbol id="symLogo" viewBox="0 0 32 32">
                <g>
                    <g transform="translate(-0.06806793,-0.06858534)">
                        <g transform="translate(-1.0833332,0.64874049)">
                            <path
                                d="m 17.151401,1.2352327 c -7.8313964,0 -14.1983698,6.339457 -14.1983698,14.1708533 0,7.831397 6.3669734,14.198371 14.1983698,14.198371 7.831397,0 14.19837,-6.366974 14.19837,-14.198371 0,-7.8313963 -6.366973,-14.1708533 -14.19837,-14.1708533 z m 0,0.9080353 c 7.334485,0 13.262819,5.9283344 13.262819,13.262818 0,7.334484 -5.928334,13.290336 -13.262819,13.290336 -7.3344838,0 -13.2628183,-5.955852 -13.2628183,-13.290336 0,-7.3344836 5.9283345,-13.262818 13.2628183,-13.262818 z"/>
                            <path
                                d="m 13.334885,28.322261 c 1.049976,0.635512 0.813218,0.640253 2.084242,0.502099 0,0 7e-6,-6.11225 0.05526,-10.042771 0.05525,-3.93052 2.413483,-6.274778 6.948442,-7.694814 3.055071,-0.956636 3.267743,-1.9168298 1.598667,-1.9168298 -5.408328,0 -8.566885,3.6979468 -8.566885,3.6979468 0,0 0.552801,-1.608397 -0.12393,-2.583228 C 13.31872,7.3864336 13.50293,11.20716 13.47304,12.836193 l -0.110524,6.023548 c -0.0703,3.83139 -0.02763,9.46252 -0.02763,9.46252 z"
                            />
                        </g>
                    </g>
                </g>
            </symbol>
        </svg>
        <header class="navbar sticky">
            <nav class="f-row">
                <ul role="list">
                    <li><a href="/">

                                <svg class="logo margin-inline">
                                    <use xlink:href="#symLogo" x="0" y="0" />
                                </svg>&nbsp;reed's website</a></li>
                </ul>
                <hr />
                <ul role="list">
                    <li><a href="/blog">blog</a></li>
                    <li><a href="/work.html">work</a></li>
                </ul>
            </nav>
        </header>
        <main hx-boost="true">
            <article
                _="
           on selectionchange from document
             set selection to document.getSelection()
             hide $commentStart

             -- First, if the selection is changing to within the comment
             -- then cancel the event entirely
             set anchorElement to selection.anchorNode
             if anchorElement.nodeType is Node.TEXT_NODE then
               -- Text nodes don't have .closest(), so get the parent element first
               set anchorElement to anchorElement.parentElement
             end
             get the closest <.comment /> to the anchorElement
             if the result is not null then
                   halt the event
                   exit
             end

             -- Don't do anything if the selection is empty
             if selection.isCollapsed then exit end

             -- Determine which comes later, the anchor or the focus
             -- https://stackoverflow.com/a/23512678
             set position to selection.anchorNode.compareDocumentPosition(selection.focusNode)
             set $commentTargetContainer to selection.focusNode
             set isSameNodeAndBackwards to ((position is 0) and (selection.anchorOffset > selection.focusOffset))
             if isSameNodeAndBackwards or (position is Node.DOCUMENT_POSITION_PRECEDING) then
               set $commentTargetContainer to selection.anchorNode
             end

             -- Find the container paragraph or other element (not text node)
             if $commentTargetContainer.nodeType is Node.TEXT_NODE then
               set $commentTargetContainer to $commentTargetContainer.parentElement
             end
             get the closest <p /> to $commentTargetContainer
             if the result is not null then
               set $commentTargetContainer to the result
             end


             -- Don't show the comment widget if the selection expands outside of the article
             get the closest <article /> to $commentTargetContainer
             if the result is null then exit end

             -- Align widget with the container
             measure element $commentTargetContainer's left, bottom
             set $commentStart's *left to left px
             set $commentStart's *top to (bottom + 10) px

             show $commentStart

             -- put the text into the comment's quote area AND a hidden input
             put selection.toString().trim() into $commentQuote
             put selection.toString().trim() into $commentSelectionInput's value
             -- add the greater context of the entire $commentTargetContainer's text
             put innerText of $commentTargetContainer into $commentContext's value
           "
            >
                <%- content %>
            </article>

            <% if (typeof discussionUrl !== "undefined") { %>
                <div class="box">
                    <strong class="block titlebar">Discuss</strong>

                    <p>Please use one of these three methods to discuss:</p>
                    <p>
                        1. Send me a <strong>private note</strong> by clicking this
                        button and filling out the form below:
                    </p>
                    <p style="display: flex; justify-content: center; align-items: center;">
                        <button
                            _="on click
                               put $comment after closest <.box />
                               trigger showWithoutSelection on $comment
                               ">
                            Leave a Private Note
                        </button>
                    </p>
                    <p>
                        2. Send me a
                        <strong>private note about a selection.</strong>
                        To do so, select some text from the article above and click the
                        "Leave a Private Note" button that appears.
                    </p>
                    <p>
                        3.
                        <strong>Discuss this post</strong> in
                        <a href="<%- discussionUrl %>" target="_blank">
                            the official thread
                        </a>
                        in the subreddit.
                    </p>
                </div>
            <% } %>

            <% if (typeof tags !== "undefined" && tags.includes("posts")) { %>
                <h3>Addenda</h3>
                <% const addenda = collections["addenda-" + page.fileSlug]; %>

                <% if (typeof addenda !== "undefined") { %>
                    <ul style="list-style: none;">
                        <% for ({ date, templateContent } of addenda) { %>
                            <li class="box plain">
                                <time class="titlebar ok" datetime="<%- date %>">
                                    <%- new Date(date).toLocaleDateString() %>
                                </time>
                                <%- templateContent %>
                            </li>
                        <% } %>
                    </ul>
                <% } else { %>
                    <p>
                        No addenda for this post yet.
                        Send me a private note if you think you have a valid addition!.
                    </p>
                <% } %>
            <% } %>
        </main>
        <footer class="navbar">
            <nav class="f-row margin-inline">
                <ul role="list">
                    <li>
                        <a href="#">back to top ↑</a>
                    </li>
                </ul>
                <hr />
                <ul role="list">
                    <li>
                        <a href="/">
                            <svg class="logo margin-inline">
                                <use xlink:href="#symLogo" x="0" y="0" />
                            </svg>
                        </a>
                    </li>
                </ul>
            </nav>
        </footer>
        <button
            class="comment-start"
            style="display: none; padding-inline: var(--gap); padding-block: calc(var(--gap) / 4); border-radius: var(--gap);"
            _="
                   init
                     set $commentStart to me
                   end

                   on click
                     put $comment after $commentTargetContainer
                     trigger showWithSelection on $comment
                     hide me
                   "
        >Leave a Private Note</button>
        <div class="comment box" style="display: none;"
             _="
                    init
                       set $comment to me
                       set $commentQuote to first <blockquote /> in me
                       set $commentSelectionInput to #comment-selection in me
                       set $commentContext to #comment-context in me
                       set $commentTargetContainer to null
                    end

                    on showWithSelection
                      -- For some reason this errors with 'Illegal invocation'
                      -- I can set a variable to this and it works, but decided against it anyways
                      -- call focus() of #comment-content
                      show <[data-hs='showWithSelection'] />
                      hide <[data-hs='showWithoutSelection'] />
                      show me
                      trigger resetResults on me
                    end

                    on showWithoutSelection
                      hide <[data-hs='showWithSelection'] />
                      show <[data-hs='showWithoutSelection'] />
                      put 'No selection' into $commentSelectionInput
                      show me
                      trigger resetResults on me
                    end
                    "
        >
            <strong
                class="block titlebar"
                style="display: flex; justify-content: space-between;"
            >
                Private Note
                <button class="close-button"
                        _="on click
                               tell closest <.comment />
                                 hide yourself
                                 trigger resetResults
                               end
                               "
                >X</button>
            </strong>
            <form
                method="POST"
                name="article-comment"
                hx-post="/"
                hx-swap="none"
                data-netlify="true"
                class="table"
                netlify-honeypot="bot-field"
                _="
                        on htmx:beforeRequest
                          trigger resetResults on closest <.comment />
                        "
            >
                <p>
                    Send me a private note.
                    <span data-hs="showWithSelection">
                        Your selection will be included:
                    </span>
                    <span data-hs="showWithoutSelection">
                        You can also select text within the article and hit the
                        "Leave a Private Note" button which appears to include a
                        selection with your comment.
                    </span>
                </p>
                <blockquote data-hs="showWithSelection" style="white-space:pre-wrap;">
                    Your selection
                </blockquote>
                <p style="display: none;">
                    <label for="comment-selection">Selection:</label>
                    <textarea
                        name="selection"
                        id="comment-selection"
                        style="width: 100%;"
                    ></textarea>
                </p>
                <p>
                    <label for="comment-content">Note:</label>
                    <textarea
                        name="content"
                        id="comment-content"
                        style="width: 100%;"
                        _="on resetCommentInput from closest <.comment />
                             set my value to ''
                        "
                    ></textarea>
                </p>
                <div class="box warn" style="display:none;"
                     _="
                            on resetResults from closest <.comment /> hide me
                            on htmx:responseError from closest <form /> hide me
                            on htmx:afterSettle from closest <form /> hide me
                            "
                >
                    <p><strong>Write a note</strong> about your selection.</p>
                    <p></p>
                </div>
                <p>
                    Please share your name, email, or other identifier to let me know who you are.
                    This will be saved to your browser and sent to me. I will never share it.
                </p>
                <p>
                    <label for="comment-contact">Contact info (optional):</label>
                    <input type="text" name="contact" value="" id="comment-contact"
                           style="width: 100%;"
                           _="
                                init
                                  set contact to localStorage.getItem('my-comment-contact')
                                  if contact then set my value to contact end
                                end
                                on input
                                 localStorage.setItem('my-comment-contact', my value)
                                 "
                    />
                </p>
                <p style="display: none;">
                    <label for="comment-context">Selection Context:</label>
                    <textarea
                        name="context"
                        id="comment-context"
                    ></textarea>
                </p>
                <p style="display: none;">
                    <label for="comment-url">Page Title:</label>
                    <input type="text" name="title" value=""
                           _="init put document.title into my value"
                    />
                </p>
                <p style="display: none;">
                    <label for="comment-url">URL:</label>
                    <input type="text" name="url" value=""
                           _="init put document.location.toString() into my value"
                    />
                </p>
                <p style="display: none;">
                    <label>
                        Don’t fill this out if you’re human: <input name="bot-field" />
                    </label>
                </p>
                <p>
                    <input type="submit" value="Send" id="comment-submit" />
                    <button class="close-button"
                            _="
                                   on click
                                     send resetResults to closest <.comment />
                                     hide closest <.comment />
                                     -- Prevent form submission
                                     halt"
                    >Cancel</button>
                </p>
                <div class="box ok" style="display: none;"
                     _="
                            on resetResults from closest <.comment /> hide me
                            on htmx:responseError from closest <form /> hide me
                            on htmx:afterSettle from closest <form /> show me
                            "
                >
                    <p>
                        <strong>Received. Thank you!</strong>
                        <button
                            style="margin-inline-start: var(--gap);"
                            _="
                               on click
                                 -- TODO what happens if this halt isn't here?
                                 halt the event
                                 tell closest <.comment />
                                   trigger resetResults
                                   trigger resetCommentInput
                                   hide me
                                 end
                               "
                        >Clear and close note box</button>
                    </p>
                </div>
                <div class="box bad" style="display:none;"
                     _="
                            on resetResults from closest <.comment /> hide me
                            on htmx:responseError from closest <form /> show me
                            on htmx:afterSettle from closest <form /> hide me
                            "
                >
                    <p><strong>Something went wrong :-/</strong></p>
                    <p>
                        I'm sorry, I don't know what happened.
                        Please email me your note at
                        <a href="mailto:reedwith2es@gmail.com">reedwith2es@gmail.com</a>
                        instead, as I really want to read your note.
                        Don't waste your time resubmitting as I can't guarantee
                        this won't happen again.
                    </p>
                </div>
            </form>
        </div>
    </body>
</html>
